<?php
if(!function_exists('in_array_r')) {
	function in_array_r($needle, $haystack, $strict = false) {
		foreach ($haystack as $item) {
			if (($strict ? $item === $needle : $item == $needle) || (is_array($item) && in_array_r($needle, $item, $strict))) {
				return true;
			}
		}
		return false;
	}
}

function unread_tickets($user){
	$tickets_query = "SELECT DISTINCT node.nid AS nid, users_node.uid AS uid, GREATEST(node.changed, node_comment_statistics.last_comment_timestamp) AS changed
		FROM node node
		LEFT JOIN comment comment_node ON node.nid = comment_node.nid
		LEFT JOIN users users_node ON node.uid = users_node.uid
		LEFT JOIN users users_comment ON comment_node.uid = users_comment.uid
		LEFT JOIN support_ticket support_ticket ON node.nid = support_ticket.nid
		LEFT JOIN users users_support_ticket ON support_ticket.assigned = users_support_ticket.uid
		LEFT JOIN support_states support_states ON support_ticket.state = support_states.sid
		INNER JOIN node_comment_statistics node_comment_statistics ON node.nid = node_comment_statistics.nid
		LEFT OUTER JOIN support_ticket st ON st.nid = node.nid
		WHERE ((( (users_node.uid = :uid) )OR( (users_comment.uid = :uid) )OR( (users_support_ticket.uid = :uid) ))AND( (node.status = '1') AND (node.type IN  ('support_ticket')) AND (support_states.state IN  ('new', 'active', 'pending')) ))AND( (st.client IN  ('1')) OR (st.client IS NULL ) )
		ORDER BY changed DESC";

 	$history_query=	"SELECT DISTINCT node.nid AS nid, history.timestamp AS history_timestamp, node.changed AS node_changed	FROM node node LEFT JOIN history history ON node.nid = history.nid AND history.uid = :uid	WHERE node.nid = :nid";
	
	$nodecounter = 'SELECT max(viewc.timestamp) AS viewc_timestamp, node.changed AS node_changed   
		FROM node node 
		LEFT JOIN nodeviewcount viewc ON node.nid = viewc.nid
		WHERE node.nid = :nid AND viewc.uid = :uid';

	$output = array();
	$i = 0;
	$tickets = db_query($tickets_query , array(':uid' => $user->uid));
	foreach($tickets as $ticket){
		$history = db_query($history_query , array(':uid' => $user->uid , ':nid' => $ticket->nid));//->execute()->fetchAll();

		foreach($history as $row){
			if(!isset($row->history_timestamp) || $row->history_timestamp < $ticket->changed){
				$result = db_query($nodecounter , array(':uid' => $user->uid , ':nid' => $ticket->nid))->fetchObject();
				if(!isset($result->viewc_timestamp) || $result->viewc_timestamp < $result->node_changed){
					$output[$i]['nid'] = $ticket->nid;
					$output[$i]['from'] = $ticket->uid;
					$i++;
				}
			}
		}
	}

	if(count($output)){
		return $output;
	}else{
		return null;
	}
}

function unread_tickets_count($user){
	return count(unread_tickets($user));
}

function student_films($uid , $detail = false){
	$user_q = "SELECT instrument.field_instrument_value AS instrument , _level.field_levelnumber_value AS level, _session.field_sessionnumber_value AS session
    FROM field_data_field_siteinfo_stu field_stu
    INNER JOIN field_data_field_instrument instrument
    INNER JOIN field_data_field_levelnumber _level
    INNER JOIN field_data_field_sessionnumber _session
    ON field_stu.field_siteinfo_stu_value = instrument.entity_id
    AND field_stu.field_siteinfo_stu_value = _level.entity_id
    AND field_stu.field_siteinfo_stu_value = _session.entity_id
    WHERE field_stu.entity_type = 'user' AND field_stu.entity_id = :uid";
	
	$nid_q = "SELECT field_stu.entity_id AS nid
    FROM field_data_field_siteinfo_stu field_stu
    INNER JOIN field_data_field_instrument instrument
    INNER JOIN field_data_field_levelnumber _level
    INNER JOIN field_data_field_sessionnumber _session
    ON field_stu.field_siteinfo_stu_value = instrument.entity_id
    AND field_stu.field_siteinfo_stu_value = _level.entity_id
    AND field_stu.field_siteinfo_stu_value = _session.entity_id
    WHERE field_stu.entity_type = 'node' AND instrument.field_instrument_value = :instrument AND _level.field_levelnumber_value = :level AND _session.field_sessionnumber_value = :session";
	
	$output = array();
	$rows = db_query($user_q , array(':uid' => $uid))->fetchAll();

	if($detail){
		foreach($rows as $row){
			$result = db_query($nid_q , array(':instrument' => $row->instrument , ':level' => $row->level , ':session' => $row->session))->fetchAll();
			foreach($result as $nid){
				$output[$row->instrument][$row->level][] = $nid->nid; 
			}
		}
	}else{
		foreach($rows as $row){
			$result = db_query($nid_q , array(':instrument' => $row->instrument , ':level' => $row->level , ':session' => $row->session))->fetchAll();
			foreach($result as $nid){
				$output[] = $nid->nid; 
			}
		}
	}

	return count($output)? $output : null;
}

function timetoexpire($uid){
	$q = db_select('uc_roles_expirations', 'r');
	$rows = $q->fields('r', array())->condition('r.uid', $uid)->execute()->fetchAll();
	$timetoexpire = 0;
	$timetoexpire_vip = 0;
	foreach ($rows as $r) {
		if($r->rid == 4){ //honarjo role id
			$timetoexpire = $r->expiration - time() ;
			$timetoexpire = $timetoexpire / (24*60*60) ;
		}else if($r->rid == 6){//vip role id
			$timetoexpire_vip = $r->expiration - time() ;
			$timetoexpire_vip = $timetoexpire_vip / (24*60*60) ;
		}
	}
	return array('honarjo'=> $timetoexpire , 'vip'=> $timetoexpire_vip);
}

function mdump($var , $die = false){
	global $user;
	if($user->uid == 1 || $user->uid == 86){
		echo '<pre>';
		print_r($var);
		echo '</pre>';
		if($die){
			die($die);
		}
	}
}

/**
 * Implements hook_menu().
 */
function functions_menu() {
  $items['admin/update-file-access'] = array(
    'title' => 'File access',
    'description' => 'File access settings.',
    'page callback' => 'update_file_access',
    'access arguments' => array('administer file access'),
	'type' => MENU_LOCAL_TASK,
  );
  $items['admin/4fasl-setting'] = array(
    'title' => 'تنظیمات دوره های 4 فصل',
    'description' => 'در اینجا میتوانید قسمت های مختلف سایت و دوره ها را به یکدیگر متصل کرد و نیازی به تغییر در کد نباشد.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('site_setting'),
    'access arguments' => array('administer modules'),
    'file' => 'functions.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function functions_theme() {
  return array(
    'functions_user_expiration' => array(
      'render element' => 'form',
      'file' => 'functions.theme.inc',
    ),
  );
}

function update_file_access(){
  define('FILE_ACCESS_USER', 1);
  $fails = $success = array();
	$values = db_query("SELECT main.entity_id AS uid , ins.field_instrument_value AS instrument, levn.field_levelnumber_value AS level, sn.field_sessionnumber_value AS session
        FROM field_data_field_siteinfo_stu main
        INNER JOIN field_data_field_instrument ins ON main.field_siteinfo_stu_value = ins.entity_id
        INNER JOIN field_data_field_levelnumber levn ON main.field_siteinfo_stu_value = levn.entity_id
        INNER JOIN field_data_field_sessionnumber sn ON main.field_siteinfo_stu_value = sn.entity_id
        WHERE main.entity_type = 'user' ORDER BY `uid` DESC");
		
	foreach($values as $row){
		$uid = $row->uid;
		$instrument = $row->instrument;
		$level = $row->level;
		$session = $row->session;
		
		
		
		//for giving user file access 
		$sql = "
			SELECT main.entity_id as nid 
			FROM field_data_field_siteinfo_stu main
			INNER JOIN field_data_field_instrument ins ON main.field_siteinfo_stu_value = ins.entity_id
			INNER JOIN field_data_field_levelnumber levn ON main.field_siteinfo_stu_value = levn.entity_id
			INNER JOIN field_data_field_sessionnumber sn ON main.field_siteinfo_stu_value = sn.entity_id
			WHERE main.entity_type = 'node' 
			AND ins.field_instrument_value = :instrument
			AND levn.field_levelnumber_value = :level
			AND sn.field_sessionnumber_value = :session" ;
		$result = db_query($sql, array(
			':instrument' =>$instrument,
			':level' =>$level,
			':session' =>$session
		));
		
		if($rows = $result->fetchAll()){
			foreach($rows as $row){
				$node = node_load($row->nid);
				if(isset($node->field_course_film['und'][0])){
					if(file_access_set_file_access($node->field_course_film['und'][0]['fid'] , $uid , NULL , FILE_ACCESS_USER)){
						$success[] = 'uid: '. $uid . ' | nid: '. $node->nid . ' | fid: '. $node->field_course_film['und'][0]['fid'] . '<br>';
					}else{
						$fails[] = 'uid: '. $uid . ' | nid: '. $node->nid . ' | fid: '. $node->field_course_film['und'][0]['fid'] . '<br>';
					}
				}
			}
		}
	}
	
	//adding accesses to files based on node_refrence field
	$results = db_query("SELECT entity_id as uid, field_node_refrence_nid as nid FROM field_data_field_node_refrence");	
	foreach($results as $result){
		$uid = $result->uid;
		$node = node_load($result->nid);

		if(isset($node->field_course_film['und'][0])){
			if(file_access_set_file_access($node->field_course_film['und'][0]['fid'] , $uid , NULL , FILE_ACCESS_USER)){
				$success[] = 'uid: '. $uid . ' | nid: '. $node->nid . ' | fid: '. $node->field_course_film['und'][0]['fid'] . '<br>';
			}else{
				$fails[] = 'uid: '. $uid . ' | nid: '. $node->nid . ' | fid: '. $node->field_course_film['und'][0]['fid'] . '<br>';
			}
		}
	}	
	
	$resault = array('success' => $success, 'fail' => $fails);
	mdump($resault ,true);
}

/**
 * Implements hook_form_user_profile_form_alter().
 */
function functions_form_user_profile_form_alter(&$form, &$form_state) {
  $account = $form_state['build_info']['args'][0];
  if (isset($form_state['build_info']['args'][1])) {
    $category = $form_state['build_info']['args'][1];
  }
  else {
    // user_profile_form() has a default value for $category.
    $category = 'account';
  }
  if (!user_access('administer users') || $category != 'account') {
    return;
  }
  
  $form['uc_roles']['expirations']['#theme'] = 'functions_user_expiration';
  
  // Create the expirations table.
  $expirations = db_query("SELECT * FROM {uc_roles_expirations} WHERE uid = :uid", array(':uid' => $account->uid));
  foreach ($expirations as $expiration) {
    $form['uc_roles']['expirations']['table'][$expiration->rid]['cancel'] = array(
		// '#title' => 'حذف '. _uc_roles_get_name($expiration->rid),
        '#type' => 'checkbox',
    );
  }

  $form['#validate'][] = 'functions_user_validate';
  return $form;
}

function functions_user_validate($form, &$form_state){
	
}

/**
 * Implements hook_user_presave().
 */
function functions_user_presave(&$edit, $account, $category) {
  if (!user_access('administer users') || $category != 'account') {
    return;
  }

  // Grant a new role if a new temporary role is added.
  if (isset($edit['new_role']) && $edit['new_role'] && $category == 'account') {
	if($edit['new_role_add'] == 4){//honarjo role id
		$type = 1; //شاگرد relationship id
		//update the user 'field_collection' data
		$expires = timetoexpire($account->uid);
		if($expires['honarjo'] == 0){
			add_collection($account , $account->field_favorite['und'][0]['value'] , 'l1' , '1');
		}
	}elseif($edit['new_role_add'] == 6){//vip role id
		$type = 3; //vip relationship id
	}

	if(($relationship = user_relationships_request_relationship($account->uid, which_teacher_name($account->field_favorite['und'][0]['value']) , $type , true)) !== FALSE){
		//message has been set in the function itself
	} else{
		drupal_set_message(t('there is a problem. please contact to support for detail.<br>code : @id , value : @val', array('@id'=> 5 , '@val' => '' ,)), 'error');
	}
  }

  // Check if any temporary role actions were taken.
  if (isset($edit['table'])) {
    foreach ((array)$edit['table'] as $rid => $value) {
      // Remove this expiration and role.
      if ($value['cancel']) {
		if($rid == 4){//honarjo role id
			$rtid = 1; //شاگرد relationship id
		}elseif($rid == 6){//vip role id
			$rtid = 3; //vip relationship id
		}
		db_delete('user_relationships')
			->condition('requester_id', $account->uid)
			->condition('rtid', $rtid)
			->execute();

        uc_roles_delete($account, $rid);
      }
    }
  }

}

/**
 * Implementation of hook_node_access().
 */
function functions_node_access($node, $op, $account){
  global $user;
  $type = is_string($node) ? $node : $node->type;
  if ($type != 'homework' || user_has_role(3 , $user)) {
    // We are only interested in support_ticket nodes.
    return NODE_ACCESS_IGNORE;
  }
  switch ($op) {
    case 'view':
	  if($user->uid == $node->uid){
        //anyone can see their practices
		$access = NODE_ACCESS_IGNORE;
	  }
	  //teacher role ID
      else if (user_has_role(5 , $user)) {
		$relation = db_select('user_relationships', 'ur')
		->fields('ur', array())
		->condition('requestee_id', $user->uid,'=')
		->condition('requester_id', $node->uid,'=')
		->condition('rtid', array(1,3),'IN') //honarjoo and vip relationship type id
		->execute()->fetchObject();
		
		if(isset($relation->rid)){ //the teacher is seeing his student
			$access = NODE_ACCESS_IGNORE;
		}
      }
      else {
        $access = NODE_ACCESS_DENY;
      }
      return $access;
  }  
}


function instrument_info($condition = '', $value = '', $fileds = array()){
	$q = db_select('site_settings', 's')->fields('s', $fileds);
	if($condition != '') $q = $q->condition($condition, $value, '=');
	$q = $q->execute()->fetchObject();
	
	if (is_object($q)){ 
		if(isset($fileds[0]) && !isset($fileds[1])){
			return $q->$fileds[0];
		}else {
			return $q;
		}
	}
}
